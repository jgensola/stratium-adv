!function(b){function a(){return b("body").height()>b(window).height()}var d=function(f,g){this.settings=g,this.checkSettings(),this.imgAnalyzerTimeout=null,this.entries=null,this.buildingRow={entriesBuff:[],width:0,height:0,aspectRatio:0},this.lastAnalyzedIndex=-1,this["yield"]={every:2,flushed:0},this.border=g.border>=0?g.border:g.margins,this.maxRowHeight=this.retrieveMaxRowHeight(),this.suffixRanges=this.retrieveSuffixRanges(),this.offY=this.border,this.spinner={phase:0,timeSlot:150,$el:b('<div class="spinner"><span></span><span></span><span></span></div>'),intervalId:null},this.checkWidthIntervalId=null,this.galleryWidth=f.width(),this.$gallery=f};d.prototype.getSuffix=function(g,f){var j,h;for(j=g>f?g:f,h=0;h<this.suffixRanges.length;h++){if(j<=this.suffixRanges[h]){return this.settings.sizeRangeSuffixes[this.suffixRanges[h]]}}return this.settings.sizeRangeSuffixes[this.suffixRanges[h-1]]},d.prototype.removeSuffix=function(f,e){return f.substring(0,f.length-e.length)},d.prototype.endsWith=function(f,e){return -1!==f.indexOf(e,f.length-e.length)},d.prototype.getUsedSuffix=function(f){for(var e in this.settings.sizeRangeSuffixes){if(this.settings.sizeRangeSuffixes.hasOwnProperty(e)){if(0===this.settings.sizeRangeSuffixes[e].length){continue}if(this.endsWith(f,this.settings.sizeRangeSuffixes[e])){return this.settings.sizeRangeSuffixes[e]}}}return""},d.prototype.newSrc=function(h,g,l,j){var m;if(this.settings.thumbnailPath){m=this.settings.thumbnailPath(h,g,l,j)}else{var k=h.match(this.settings.extension),f=null!==k?k[0]:"";m=h.replace(this.settings.extension,""),m=this.removeSuffix(m,this.getUsedSuffix(m)),m+=this.getSuffix(g,l)+f}return m},d.prototype.showImg=function(f,e){this.settings.cssAnimation?(f.addClass("entry-visible"),e&&e()):f.stop().fadeTo(this.settings.imagesAnimationDuration,1,e)},d.prototype.extractImgSrcFromImage=function(f){var e="undefined"!=typeof f.data("safe-src")?f.data("safe-src"):f.attr("src");return f.data("jg.originalSrc",e),e},d.prototype.imgFromEntry=function(f){var e=f.find("> img");return 0===e.length&&(e=f.find("> a > img")),0===e.length?null:e},d.prototype.captionFromEntry=function(f){var e=f.find("> .caption");return 0===e.length?null:e},d.prototype.displayEntry=function(p,u,w,k,f,v){p.width(k),p.height(v),p.css("top",w),p.css("left",u);var j=this.imgFromEntry(p);if(null!==j){j.css("width",k),j.css("height",f),j.css("margin-left",-k/2),j.css("margin-top",-f/2);var q=j.attr("src"),t=this.newSrc(q,k,f,j);j.one("error",function(){j.attr("src",j.data("jg.originalSrc"))});var m=function(){q!==t&&j.attr("src",t)};"skipped"===p.data("jg.loaded")?this.onImageEvent(q,b.proxy(function(){this.showImg(p,m),p.data("jg.loaded",!0)},this)):this.showImg(p,m)}else{this.showImg(p)}this.displayEntryCaption(p)},d.prototype.displayEntryCaption=function(f){var h=this.imgFromEntry(f);if(null!==h&&this.settings.captions){var g=this.captionFromEntry(f);if(null===g){var j=h.attr("alt");this.isValidCaption(j)||(j=f.attr("title")),this.isValidCaption(j)&&(g=b('<div class="caption">'+j+"</div>"),f.append(g),f.data("jg.createdCaption",!0))}null!==g&&(this.settings.cssAnimation||g.stop().fadeTo(0,this.settings.captionSettings.nonVisibleOpacity),this.addCaptionEventsHandlers(f))}else{this.removeCaptionEventsHandlers(f)}},d.prototype.isValidCaption=function(e){return"undefined"!=typeof e&&e.length>0},d.prototype.onEntryMouseEnterForCaption=function(f){var g=this.captionFromEntry(b(f.currentTarget));this.settings.cssAnimation?g.addClass("caption-visible").removeClass("caption-hidden"):g.stop().fadeTo(this.settings.captionSettings.animationDuration,this.settings.captionSettings.visibleOpacity)},d.prototype.onEntryMouseLeaveForCaption=function(f){var g=this.captionFromEntry(b(f.currentTarget));this.settings.cssAnimation?g.removeClass("caption-visible").removeClass("caption-hidden"):g.stop().fadeTo(this.settings.captionSettings.animationDuration,this.settings.captionSettings.nonVisibleOpacity)},d.prototype.addCaptionEventsHandlers=function(f){var g=f.data("jg.captionMouseEvents");"undefined"==typeof g&&(g={mouseenter:b.proxy(this.onEntryMouseEnterForCaption,this),mouseleave:b.proxy(this.onEntryMouseLeaveForCaption,this)},f.on("mouseenter",void 0,void 0,g.mouseenter),f.on("mouseleave",void 0,void 0,g.mouseleave),f.data("jg.captionMouseEvents",g))},d.prototype.removeCaptionEventsHandlers=function(f){var e=f.data("jg.captionMouseEvents");"undefined"!=typeof e&&(f.off("mouseenter",void 0,e.mouseenter),f.off("mouseleave",void 0,e.mouseleave),f.removeData("jg.captionMouseEvents"))},d.prototype.prepareBuildingRow=function(x){var p,v,y,k,f,w=!0,j=0,q=this.galleryWidth-2*this.border-(this.buildingRow.entriesBuff.length-1)*this.settings.margins,u=q/this.buildingRow.aspectRatio,m=this.buildingRow.width/q>this.settings.justifyThreshold;if(x&&"hide"===this.settings.lastRow&&!m){for(p=0;p<this.buildingRow.entriesBuff.length;p++){v=this.buildingRow.entriesBuff[p],this.settings.cssAnimation?v.removeClass("entry-visible"):v.stop().fadeTo(0,0)}return -1}for(x&&!m&&"justify"!==this.settings.lastRow&&"hide"!==this.settings.lastRow&&(w=!1),p=0;p<this.buildingRow.entriesBuff.length;p++){v=this.buildingRow.entriesBuff[p],y=v.data("jg.width")/v.data("jg.height"),w?(k=p===this.buildingRow.entriesBuff.length-1?q:u*y,f=u):(k=this.settings.rowHeight*y,f=this.settings.rowHeight),q-=Math.round(k),v.data("jg.jwidth",Math.round(k)),v.data("jg.jheight",Math.ceil(f)),(0===p||j>f)&&(j=f)}return this.settings.fixedHeight&&j>this.settings.rowHeight&&(j=this.settings.rowHeight),this.buildingRow.height=j,w},d.prototype.clearBuildingRow=function(){this.buildingRow.entriesBuff=[],this.buildingRow.aspectRatio=0,this.buildingRow.width=0},d.prototype.flushRow=function(h){var g,l,j,m=this.settings,k=this.border;if(l=this.prepareBuildingRow(h),h&&"hide"===m.lastRow&&-1===this.buildingRow.height){return void this.clearBuildingRow()}if(this.maxRowHeight.isPercentage?this.maxRowHeight.value*m.rowHeight<this.buildingRow.height&&(this.buildingRow.height=this.maxRowHeight.value*m.rowHeight):this.maxRowHeight.value>0&&this.maxRowHeight.value<this.buildingRow.height&&(this.buildingRow.height=this.maxRowHeight.value),"center"===m.lastRow||"right"===m.lastRow){var f=this.galleryWidth-2*this.border-(this.buildingRow.entriesBuff.length-1)*m.margins;for(j=0;j<this.buildingRow.entriesBuff.length;j++){g=this.buildingRow.entriesBuff[j],f-=g.data("jg.jwidth")}"center"===m.lastRow?k+=f/2:"right"===m.lastRow&&(k+=f)}for(j=0;j<this.buildingRow.entriesBuff.length;j++){g=this.buildingRow.entriesBuff[j],this.displayEntry(g,k,this.offY,g.data("jg.jwidth"),g.data("jg.jheight"),this.buildingRow.height),k+=g.data("jg.jwidth")+m.margins}this.galleryHeightToSet=this.offY+this.buildingRow.height+this.border+(this.isSpinnerActive()?this.getSpinnerHeight():0),(!h||this.buildingRow.height<=m.rowHeight&&l)&&(this.offY+=this.buildingRow.height+m.margins,this.clearBuildingRow(),this.$gallery.trigger("jg.rowflush"))};var c=!1;d.prototype.checkWidth=function(){this.checkWidthIntervalId=setInterval(b.proxy(function(){var e=parseFloat(this.$gallery.width());a()===c?Math.abs(e-this.galleryWidth)>this.settings.refreshSensitivity&&(this.galleryWidth=e,this.rewind(),this.startImgAnalyzer(!0)):(c=a(),this.galleryWidth=e)},this),this.settings.refreshTime)},d.prototype.isSpinnerActive=function(){return null!==this.spinner.intervalId},d.prototype.getSpinnerHeight=function(){return this.spinner.$el.innerHeight()},d.prototype.stopLoadingSpinnerAnimation=function(){clearInterval(this.spinner.intervalId),this.spinner.intervalId=null,this.$gallery.height(this.$gallery.height()-this.getSpinnerHeight()),this.spinner.$el.detach()},d.prototype.startLoadingSpinnerAnimation=function(){var f=this.spinner,e=f.$el.find("span");clearInterval(f.intervalId),this.$gallery.append(f.$el),this.$gallery.height(this.offY+this.buildingRow.height+this.getSpinnerHeight()),f.intervalId=setInterval(function(){f.phase<e.length?e.eq(f.phase).fadeTo(f.timeSlot,1):e.eq(f.phase-e.length).fadeTo(f.timeSlot,0),f.phase=(f.phase+1)%(2*e.length)},f.timeSlot)},d.prototype.rewind=function(){this.lastAnalyzedIndex=-1,this.offY=this.border,this.clearBuildingRow()},d.prototype.updateEntries=function(e){return this.entries=this.$gallery.find(this.settings.selector).toArray(),0===this.entries.length?!1:(this.settings.filter?this.modifyEntries(this.filterArray,e):this.modifyEntries(this.resetFilters,e),b.isFunction(this.settings.sort)?this.modifyEntries(this.sortArray,e):this.settings.randomize&&this.modifyEntries(this.shuffleArray,e),!0)},d.prototype.insertToGallery=function(f){var g=this;b.each(f,function(){b(this).appendTo(g.$gallery)})},d.prototype.shuffleArray=function(g){var f,j,h;for(f=g.length-1;f>0;f--){j=Math.floor(Math.random()*(f+1)),h=g[f],g[f]=g[j],g[j]=h}return this.insertToGallery(g),g},d.prototype.sortArray=function(e){return e.sort(this.settings.sort),this.insertToGallery(e),e},d.prototype.resetFilters=function(f){for(var g=0;g<f.length;g++){b(f[g]).removeClass("jg-filtered")}return f},d.prototype.filterArray=function(f){var g=this.settings;return"string"===b.type(g.filter)?f.filter(function(e){var h=b(e);return h.is(g.filter)?(h.removeClass("jg-filtered"),!0):(h.addClass("jg-filtered"),!1)}):b.isFunction(g.filter)?f.filter(g.filter):void 0},d.prototype.modifyEntries=function(g,f){var h=f?this.entries.splice(this.lastAnalyzedIndex+1,this.entries.length-this.lastAnalyzedIndex-1):this.entries;h=g.call(this,h),this.entries=f?this.entries.concat(h):h},d.prototype.destroy=function(){clearInterval(this.checkWidthIntervalId),b.each(this.entries,b.proxy(function(f,j){var g=b(j);g.css("width",""),g.css("height",""),g.css("top",""),g.css("left",""),g.data("jg.loaded",void 0),g.removeClass("jg-entry");var k=this.imgFromEntry(g);k.css("width",""),k.css("height",""),k.css("margin-left",""),k.css("margin-top",""),k.attr("src",k.data("jg.originalSrc")),k.data("jg.originalSrc",void 0),this.removeCaptionEventsHandlers(g);var h=this.captionFromEntry(g);g.data("jg.createdCaption")?(g.data("jg.createdCaption",void 0),null!==h&&h.remove()):null!==h&&h.fadeTo(0,1)},this)),this.$gallery.css("height",""),this.$gallery.removeClass("justified-gallery"),this.$gallery.data("jg.controller",void 0)},d.prototype.analyzeImages=function(f){for(var j=this.lastAnalyzedIndex+1;j<this.entries.length;j++){var g=b(this.entries[j]);if(g.data("jg.loaded")===!0||"skipped"===g.data("jg.loaded")){var k=this.galleryWidth-2*this.border-(this.buildingRow.entriesBuff.length-1)*this.settings.margins,h=g.data("jg.width")/g.data("jg.height");if(k/(this.buildingRow.aspectRatio+h)<this.settings.rowHeight&&(this.flushRow(!1),++this["yield"].flushed>=this["yield"].every)){return void this.startImgAnalyzer(f)}this.buildingRow.entriesBuff.push(g),this.buildingRow.aspectRatio+=h,this.buildingRow.width+=h*this.settings.rowHeight,this.lastAnalyzedIndex=j}else{if("error"!==g.data("jg.loaded")){return}}}this.buildingRow.entriesBuff.length>0&&this.flushRow(!0),this.isSpinnerActive()&&this.stopLoadingSpinnerAnimation(),this.stopImgAnalyzerStarter(),this.$gallery.trigger(f?"jg.resize":"jg.complete"),this.$gallery.height(this.galleryHeightToSet)},d.prototype.stopImgAnalyzerStarter=function(){this["yield"].flushed=0,null!==this.imgAnalyzerTimeout&&clearTimeout(this.imgAnalyzerTimeout)},d.prototype.startImgAnalyzer=function(f){var e=this;this.stopImgAnalyzerStarter(),this.imgAnalyzerTimeout=setTimeout(function(){e.analyzeImages(f)},0.001)},d.prototype.onImageEvent=function(f,j,g){if(j||g){var k=new Image,h=b(k);j&&h.one("load",function(){h.off("load error"),j(k)}),g&&h.one("error",function(){h.off("load error"),g(k)}),k.src=f}},d.prototype.init=function(){var f=!1,h=!1,g=this;b.each(this.entries,function(q,m){var i=b(m),p=g.imgFromEntry(i);if(i.addClass("jg-entry"),i.data("jg.loaded")!==!0&&"skipped"!==i.data("jg.loaded")){if(null!==g.settings.rel&&i.attr("rel",g.settings.rel),null!==g.settings.target&&i.attr("target",g.settings.target),null!==p){var j=g.extractImgSrcFromImage(p);if(p.attr("src",j),g.settings.waitThumbnailsLoad===!1){var k=parseFloat(p.attr("width")),e=parseFloat(p.attr("height"));if(!isNaN(k)&&!isNaN(e)){return i.data("jg.width",k),i.data("jg.height",e),i.data("jg.loaded","skipped"),h=!0,g.startImgAnalyzer(!1),!0}}i.data("jg.loaded",!1),f=!0,g.isSpinnerActive()||g.startLoadingSpinnerAnimation(),g.onImageEvent(j,function(l){i.data("jg.width",l.width),i.data("jg.height",l.height),i.data("jg.loaded",!0),g.startImgAnalyzer(!1)},function(){i.data("jg.loaded","error"),g.startImgAnalyzer(!1)})}else{i.data("jg.loaded",!0),i.data("jg.width",i.width()|parseFloat(i.css("width"))|1),i.data("jg.height",i.height()|parseFloat(i.css("height"))|1)}}}),f||h||this.startImgAnalyzer(!1),this.checkWidth()},d.prototype.checkOrConvertNumber=function(f,g){if("string"===b.type(f[g])&&(f[g]=parseFloat(f[g])),"number"!==b.type(f[g])){throw g+" must be a number"}if(isNaN(f[g])){throw"invalid number for "+g}},d.prototype.checkSizeRangesSuffixes=function(){if("object"!==b.type(this.settings.sizeRangeSuffixes)){throw"sizeRangeSuffixes must be defined and must be an object"}var g=[];for(var k in this.settings.sizeRangeSuffixes){this.settings.sizeRangeSuffixes.hasOwnProperty(k)&&g.push(k)}for(var h={0:""},l=0;l<g.length;l++){if("string"===b.type(g[l])){try{var j=parseInt(g[l].replace(/^[a-z]+/,""),10);h[j]=this.settings.sizeRangeSuffixes[g[l]]}catch(f){throw"sizeRangeSuffixes keys must contains correct numbers ("+f+")"}}else{h[g[l]]=this.settings.sizeRangeSuffixes[g[l]]}}this.settings.sizeRangeSuffixes=h},d.prototype.retrieveMaxRowHeight=function(){var e={};if("string"===b.type(this.settings.maxRowHeight)){this.settings.maxRowHeight.match(/^[0-9]+%$/)?(e.value=parseFloat(this.settings.maxRowHeight.match(/^([0-9]+)%$/)[1])/100,e.isPercentage=!1):(e.value=parseFloat(this.settings.maxRowHeight),e.isPercentage=!0)}else{if("number"!==b.type(this.settings.maxRowHeight)){throw"maxRowHeight must be a number or a percentage"}e.value=this.settings.maxRowHeight,e.isPercentage=!1}if(isNaN(e.value)){throw"invalid number for maxRowHeight"}return e.isPercentage?e.value<100&&(e.value=100):e.value>0&&e.value<this.settings.rowHeight&&(e.value=this.settings.rowHeight),e},d.prototype.checkSettings=function(){if(this.checkSizeRangesSuffixes(),this.checkOrConvertNumber(this.settings,"rowHeight"),this.checkOrConvertNumber(this.settings,"margins"),this.checkOrConvertNumber(this.settings,"border"),"justify"!==this.settings.lastRow&&"nojustify"!==this.settings.lastRow&&"left"!==this.settings.lastRow&&"center"!==this.settings.lastRow&&"right"!==this.settings.lastRow&&"hide"!==this.settings.lastRow){throw'lastRow must be "justify", "nojustify", "left", "center", "right" or "hide"'}if(this.checkOrConvertNumber(this.settings,"justifyThreshold"),this.settings.justifyThreshold<0||this.settings.justifyThreshold>1){throw"justifyThreshold must be in the interval [0,1]"}if("boolean"!==b.type(this.settings.cssAnimation)){throw"cssAnimation must be a boolean"}if("boolean"!==b.type(this.settings.captions)){throw"captions must be a boolean"}if(this.checkOrConvertNumber(this.settings.captionSettings,"animationDuration"),this.checkOrConvertNumber(this.settings.captionSettings,"visibleOpacity"),this.settings.captionSettings.visibleOpacity<0||this.settings.captionSettings.visibleOpacity>1){throw"captionSettings.visibleOpacity must be in the interval [0, 1]"}if(this.checkOrConvertNumber(this.settings.captionSettings,"nonVisibleOpacity"),this.settings.captionSettings.nonVisibleOpacity<0||this.settings.captionSettings.nonVisibleOpacity>1){throw"captionSettings.nonVisibleOpacity must be in the interval [0, 1]"}if("boolean"!==b.type(this.settings.fixedHeight)){throw"fixedHeight must be a boolean"}if(this.checkOrConvertNumber(this.settings,"imagesAnimationDuration"),this.checkOrConvertNumber(this.settings,"refreshTime"),this.checkOrConvertNumber(this.settings,"refreshSensitivity"),"boolean"!==b.type(this.settings.randomize)){throw"randomize must be a boolean"}if("string"!==b.type(this.settings.selector)){throw"selector must be a string"}if(this.settings.sort!==!1&&!b.isFunction(this.settings.sort)){throw"sort must be false or a comparison function"}if(this.settings.filter!==!1&&!b.isFunction(this.settings.filter)&&"string"!==b.type(this.settings.filter)){throw"filter must be false, a string or a filter function"}},d.prototype.retrieveSuffixRanges=function(){var f=[];for(var e in this.settings.sizeRangeSuffixes){this.settings.sizeRangeSuffixes.hasOwnProperty(e)&&f.push(parseInt(e,10))}return f.sort(function(h,g){return h>g?1:g>h?-1:0}),f},d.prototype.updateSettings=function(e){this.settings=b.extend({},this.settings,e),this.checkSettings(),this.border=this.settings.border>=0?this.settings.border:this.settings.margins,this.maxRowHeight=this.retrieveMaxRowHeight(),this.suffixRanges=this.retrieveSuffixRanges()},b.fn.justifiedGallery=function(e){return this.each(function(g,i){var h=b(i);h.addClass("justified-gallery");var f=h.data("jg.controller");if("undefined"==typeof f){if("undefined"!=typeof e&&null!==e&&"object"!==b.type(e)){if("destroy"===e){return}throw"The argument must be an object"}f=new d(h,b.extend({},b.fn.justifiedGallery.defaults,e)),h.data("jg.controller",f)}else{if("norewind"===e){}else{if("destroy"===e){return void f.destroy()}f.updateSettings(e),f.rewind()}}f.updateEntries("norewind"===e)&&f.init()})},b.fn.justifiedGallery.defaults={sizeRangeSuffixes:{},thumbnailPath:void 0,rowHeight:120,maxRowHeight:-1,margins:1,border:-1,lastRow:"nojustify",justifyThreshold:0.75,fixedHeight:!1,waitThumbnailsLoad:!0,captions:!0,cssAnimation:!1,imagesAnimationDuration:500,captionSettings:{animationDuration:500,visibleOpacity:0.7,nonVisibleOpacity:0},rel:null,target:null,extension:/\.[^.\\/]+$/,refreshTime:200,refreshSensitivity:0,randomize:!1,sort:!1,filter:!1,selector:"> a, > div:not(.spinner)"}}(jQuery);