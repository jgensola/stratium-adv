!function(e){function f(){return e("body").height()>e(window).height()}var g=function(b,a){this.settings=a,this.checkSettings(),this.imgAnalyzerTimeout=null,this.entries=null,this.buildingRow={entriesBuff:[],width:0,height:0,aspectRatio:0},this.lastAnalyzedIndex=-1,this["yield"]={every:2,flushed:0},this.border=a.border>=0?a.border:a.margins,this.maxRowHeight=this.retrieveMaxRowHeight(),this.suffixRanges=this.retrieveSuffixRanges(),this.offY=this.border,this.spinner={phase:0,timeSlot:150,$el:e('<div class="spinner"><span></span><span></span><span></span></div>'),intervalId:null},this.checkWidthIntervalId=null,this.galleryWidth=b.width(),this.$gallery=b};g.prototype.getSuffix=function(c,d){var a,b;for(a=c>d?c:d,b=0;b<this.suffixRanges.length;b++){if(a<=this.suffixRanges[b]){return this.settings.sizeRangeSuffixes[this.suffixRanges[b]]}}return this.settings.sizeRangeSuffixes[this.suffixRanges[b-1]]},g.prototype.removeSuffix=function(a,b){return a.substring(0,a.length-b.length)},g.prototype.endsWith=function(a,b){return -1!==a.indexOf(b,a.length-b.length)},g.prototype.getUsedSuffix=function(a){for(var b in this.settings.sizeRangeSuffixes){if(this.settings.sizeRangeSuffixes.hasOwnProperty(b)){if(0===this.settings.sizeRangeSuffixes[b].length){continue}if(this.endsWith(a,this.settings.sizeRangeSuffixes[b])){return this.settings.sizeRangeSuffixes[b]}}}return""},g.prototype.newSrc=function(i,n,b,d){var a;if(this.settings.thumbnailPath){a=this.settings.thumbnailPath(i,n,b,d)}else{var c=i.match(this.settings.extension),o=null!==c?c[0]:"";a=i.replace(this.settings.extension,""),a=this.removeSuffix(a,this.getUsedSuffix(a)),a+=this.getSuffix(n,b)+o}return a},g.prototype.showImg=function(a,b){this.settings.cssAnimation?(a.addClass("entry-visible"),b&&b()):a.stop().fadeTo(this.settings.imagesAnimationDuration,1,b)},g.prototype.extractImgSrcFromImage=function(a){var b="undefined"!=typeof a.data("safe-src")?a.data("safe-src"):a.attr("src");return a.data("jg.originalSrc",b),b},g.prototype.imgFromEntry=function(a){var b=a.find("> img");return 0===b.length&&(b=a.find("> a > img")),0===b.length?null:b},g.prototype.captionFromEntry=function(a){var b=a.find("> .caption");return 0===b.length?null:b},g.prototype.displayEntry=function(b,r,n,d,l,o){b.width(d),b.height(o),b.css("top",n),b.css("left",r);var i=this.imgFromEntry(b);if(null!==i){i.css("width",d),i.css("height",l),i.css("margin-left",-d/2),i.css("margin-top",-l/2);var a=i.attr("src"),s=this.newSrc(a,d,l,i);i.one("error",function(){i.attr("src",i.data("jg.originalSrc"))});var c=function(){a!==s&&i.attr("src",s)};"skipped"===b.data("jg.loaded")?this.onImageEvent(a,e.proxy(function(){this.showImg(b,c),b.data("jg.loaded",!0)},this)):this.showImg(b,c)}else{this.showImg(b)}this.displayEntryCaption(b)},g.prototype.displayEntryCaption=function(d){var b=this.imgFromEntry(d);if(null!==b&&this.settings.captions){var c=this.captionFromEntry(d);if(null===c){var a=b.attr("alt");this.isValidCaption(a)||(a=d.attr("title")),this.isValidCaption(a)&&(c=e('<div class="caption">'+a+"</div>"),d.append(c),d.data("jg.createdCaption",!0))}null!==c&&(this.settings.cssAnimation||c.stop().fadeTo(0,this.settings.captionSettings.nonVisibleOpacity),this.addCaptionEventsHandlers(d))}else{this.removeCaptionEventsHandlers(d)}},g.prototype.isValidCaption=function(a){return"undefined"!=typeof a&&a.length>0},g.prototype.onEntryMouseEnterForCaption=function(b){var a=this.captionFromEntry(e(b.currentTarget));this.settings.cssAnimation?a.addClass("caption-visible").removeClass("caption-hidden"):a.stop().fadeTo(this.settings.captionSettings.animationDuration,this.settings.captionSettings.visibleOpacity)},g.prototype.onEntryMouseLeaveForCaption=function(b){var a=this.captionFromEntry(e(b.currentTarget));this.settings.cssAnimation?a.removeClass("caption-visible").removeClass("caption-hidden"):a.stop().fadeTo(this.settings.captionSettings.animationDuration,this.settings.captionSettings.nonVisibleOpacity)},g.prototype.addCaptionEventsHandlers=function(b){var a=b.data("jg.captionMouseEvents");"undefined"==typeof a&&(a={mouseenter:e.proxy(this.onEntryMouseEnterForCaption,this),mouseleave:e.proxy(this.onEntryMouseLeaveForCaption,this)},b.on("mouseenter",void 0,void 0,a.mouseenter),b.on("mouseleave",void 0,void 0,a.mouseleave),b.data("jg.captionMouseEvents",a))},g.prototype.removeCaptionEventsHandlers=function(a){var b=a.data("jg.captionMouseEvents");"undefined"!=typeof b&&(a.off("mouseenter",void 0,b.mouseenter),a.off("mouseleave",void 0,b.mouseleave),a.removeData("jg.captionMouseEvents"))},g.prototype.prepareBuildingRow=function(o){var b,s,n,d,l,r=!0,i=0,a=this.galleryWidth-2*this.border-(this.buildingRow.entriesBuff.length-1)*this.settings.margins,t=a/this.buildingRow.aspectRatio,c=this.buildingRow.width/a>this.settings.justifyThreshold;if(o&&"hide"===this.settings.lastRow&&!c){for(b=0;b<this.buildingRow.entriesBuff.length;b++){s=this.buildingRow.entriesBuff[b],this.settings.cssAnimation?s.removeClass("entry-visible"):s.stop().fadeTo(0,0)}return -1}for(o&&!c&&"justify"!==this.settings.lastRow&&"hide"!==this.settings.lastRow&&(r=!1),b=0;b<this.buildingRow.entriesBuff.length;b++){s=this.buildingRow.entriesBuff[b],n=s.data("jg.width")/s.data("jg.height"),r?(d=b===this.buildingRow.entriesBuff.length-1?a:t*n,l=t):(d=this.settings.rowHeight*n,l=this.settings.rowHeight),a-=Math.round(d),s.data("jg.jwidth",Math.round(d)),s.data("jg.jheight",Math.ceil(l)),(0===b||i>l)&&(i=l)}return this.settings.fixedHeight&&i>this.settings.rowHeight&&(i=this.settings.rowHeight),this.buildingRow.height=i,r},g.prototype.clearBuildingRow=function(){this.buildingRow.entriesBuff=[],this.buildingRow.aspectRatio=0,this.buildingRow.width=0},g.prototype.flushRow=function(i){var n,b,d,a=this.settings,c=this.border;if(b=this.prepareBuildingRow(i),i&&"hide"===a.lastRow&&-1===this.buildingRow.height){return void this.clearBuildingRow()}if(this.maxRowHeight.isPercentage?this.maxRowHeight.value*a.rowHeight<this.buildingRow.height&&(this.buildingRow.height=this.maxRowHeight.value*a.rowHeight):this.maxRowHeight.value>0&&this.maxRowHeight.value<this.buildingRow.height&&(this.buildingRow.height=this.maxRowHeight.value),"center"===a.lastRow||"right"===a.lastRow){var o=this.galleryWidth-2*this.border-(this.buildingRow.entriesBuff.length-1)*a.margins;for(d=0;d<this.buildingRow.entriesBuff.length;d++){n=this.buildingRow.entriesBuff[d],o-=n.data("jg.jwidth")}"center"===a.lastRow?c+=o/2:"right"===a.lastRow&&(c+=o)}for(d=0;d<this.buildingRow.entriesBuff.length;d++){n=this.buildingRow.entriesBuff[d],this.displayEntry(n,c,this.offY,n.data("jg.jwidth"),n.data("jg.jheight"),this.buildingRow.height),c+=n.data("jg.jwidth")+a.margins}this.galleryHeightToSet=this.offY+this.buildingRow.height+this.border+(this.isSpinnerActive()?this.getSpinnerHeight():0),(!i||this.buildingRow.height<=a.rowHeight&&b)&&(this.offY+=this.buildingRow.height+a.margins,this.clearBuildingRow(),this.$gallery.trigger("jg.rowflush"))};var h=!1;g.prototype.checkWidth=function(){this.checkWidthIntervalId=setInterval(e.proxy(function(){var a=parseFloat(this.$gallery.width());f()===h?Math.abs(a-this.galleryWidth)>this.settings.refreshSensitivity&&(this.galleryWidth=a,this.rewind(),this.startImgAnalyzer(!0)):(h=f(),this.galleryWidth=a)},this),this.settings.refreshTime)},g.prototype.isSpinnerActive=function(){return null!==this.spinner.intervalId},g.prototype.getSpinnerHeight=function(){return this.spinner.$el.innerHeight()},g.prototype.stopLoadingSpinnerAnimation=function(){clearInterval(this.spinner.intervalId),this.spinner.intervalId=null,this.$gallery.height(this.$gallery.height()-this.getSpinnerHeight()),this.spinner.$el.detach()},g.prototype.startLoadingSpinnerAnimation=function(){var a=this.spinner,b=a.$el.find("span");clearInterval(a.intervalId),this.$gallery.append(a.$el),this.$gallery.height(this.offY+this.buildingRow.height+this.getSpinnerHeight()),a.intervalId=setInterval(function(){a.phase<b.length?b.eq(a.phase).fadeTo(a.timeSlot,1):b.eq(a.phase-b.length).fadeTo(a.timeSlot,0),a.phase=(a.phase+1)%(2*b.length)},a.timeSlot)},g.prototype.rewind=function(){this.lastAnalyzedIndex=-1,this.offY=this.border,this.clearBuildingRow()},g.prototype.updateEntries=function(a){return this.entries=this.$gallery.find(this.settings.selector).toArray(),0===this.entries.length?!1:(this.settings.filter?this.modifyEntries(this.filterArray,a):this.modifyEntries(this.resetFilters,a),e.isFunction(this.settings.sort)?this.modifyEntries(this.sortArray,a):this.settings.randomize&&this.modifyEntries(this.shuffleArray,a),!0)},g.prototype.insertToGallery=function(b){var a=this;e.each(b,function(){e(this).appendTo(a.$gallery)})},g.prototype.shuffleArray=function(c){var d,a,b;for(d=c.length-1;d>0;d--){a=Math.floor(Math.random()*(d+1)),b=c[d],c[d]=c[a],c[a]=b}return this.insertToGallery(c),c},g.prototype.sortArray=function(a){return a.sort(this.settings.sort),this.insertToGallery(a),a},g.prototype.resetFilters=function(b){for(var a=0;a<b.length;a++){e(b[a]).removeClass("jg-filtered")}return b},g.prototype.filterArray=function(b){var a=this.settings;return"string"===e.type(a.filter)?b.filter(function(d){var c=e(d);return c.is(a.filter)?(c.removeClass("jg-filtered"),!0):(c.addClass("jg-filtered"),!1)}):e.isFunction(a.filter)?b.filter(a.filter):void 0},g.prototype.modifyEntries=function(b,c){var a=c?this.entries.splice(this.lastAnalyzedIndex+1,this.entries.length-this.lastAnalyzedIndex-1):this.entries;a=b.call(this,a),this.entries=c?this.entries.concat(a):a},g.prototype.destroy=function(){clearInterval(this.checkWidthIntervalId),e.each(this.entries,e.proxy(function(i,b){var d=e(b);d.css("width",""),d.css("height",""),d.css("top",""),d.css("left",""),d.data("jg.loaded",void 0),d.removeClass("jg-entry");var a=this.imgFromEntry(d);a.css("width",""),a.css("height",""),a.css("margin-left",""),a.css("margin-top",""),a.attr("src",a.data("jg.originalSrc")),a.data("jg.originalSrc",void 0),this.removeCaptionEventsHandlers(d);var c=this.captionFromEntry(d);d.data("jg.createdCaption")?(d.data("jg.createdCaption",void 0),null!==c&&c.remove()):null!==c&&c.fadeTo(0,1)},this)),this.$gallery.css("height",""),this.$gallery.removeClass("justified-gallery"),this.$gallery.data("jg.controller",void 0)},g.prototype.analyzeImages=function(i){for(var b=this.lastAnalyzedIndex+1;b<this.entries.length;b++){var d=e(this.entries[b]);if(d.data("jg.loaded")===!0||"skipped"===d.data("jg.loaded")){var a=this.galleryWidth-2*this.border-(this.buildingRow.entriesBuff.length-1)*this.settings.margins,c=d.data("jg.width")/d.data("jg.height");if(a/(this.buildingRow.aspectRatio+c)<this.settings.rowHeight&&(this.flushRow(!1),++this["yield"].flushed>=this["yield"].every)){return void this.startImgAnalyzer(i)}this.buildingRow.entriesBuff.push(d),this.buildingRow.aspectRatio+=c,this.buildingRow.width+=c*this.settings.rowHeight,this.lastAnalyzedIndex=b}else{if("error"!==d.data("jg.loaded")){return}}}this.buildingRow.entriesBuff.length>0&&this.flushRow(!0),this.isSpinnerActive()&&this.stopLoadingSpinnerAnimation(),this.stopImgAnalyzerStarter(),this.$gallery.trigger(i?"jg.resize":"jg.complete"),this.$gallery.height(this.galleryHeightToSet)},g.prototype.stopImgAnalyzerStarter=function(){this["yield"].flushed=0,null!==this.imgAnalyzerTimeout&&clearTimeout(this.imgAnalyzerTimeout)},g.prototype.startImgAnalyzer=function(a){var b=this;this.stopImgAnalyzerStarter(),this.imgAnalyzerTimeout=setTimeout(function(){b.analyzeImages(a)},0.001)},g.prototype.onImageEvent=function(i,b,d){if(b||d){var a=new Image,c=e(a);b&&c.one("load",function(){c.off("load error"),b(a)}),d&&c.one("error",function(){c.off("load error"),d(a)}),a.src=i}},g.prototype.init=function(){var c=!1,a=!1,b=this;e.each(this.entries,function(r,d){var o=e(d),t=b.imgFromEntry(o);if(o.addClass("jg-entry"),o.data("jg.loaded")!==!0&&"skipped"!==o.data("jg.loaded")){if(null!==b.settings.rel&&o.attr("rel",b.settings.rel),null!==b.settings.target&&o.attr("target",b.settings.target),null!==t){var n=b.extractImgSrcFromImage(t);if(t.attr("src",n),b.settings.waitThumbnailsLoad===!1){var l=parseFloat(t.attr("width")),s=parseFloat(t.attr("height"));if(!isNaN(l)&&!isNaN(s)){return o.data("jg.width",l),o.data("jg.height",s),o.data("jg.loaded","skipped"),a=!0,b.startImgAnalyzer(!1),!0}}o.data("jg.loaded",!1),c=!0,b.isSpinnerActive()||b.startLoadingSpinnerAnimation(),b.onImageEvent(n,function(i){o.data("jg.width",i.width),o.data("jg.height",i.height),o.data("jg.loaded",!0),b.startImgAnalyzer(!1)},function(){o.data("jg.loaded","error"),b.startImgAnalyzer(!1)})}else{o.data("jg.loaded",!0),o.data("jg.width",o.width()|parseFloat(o.css("width"))|1),o.data("jg.height",o.height()|parseFloat(o.css("height"))|1)}}}),c||a||this.startImgAnalyzer(!1),this.checkWidth()},g.prototype.checkOrConvertNumber=function(b,a){if("string"===e.type(b[a])&&(b[a]=parseFloat(b[a])),"number"!==e.type(b[a])){throw a+" must be a number"}if(isNaN(b[a])){throw"invalid number for "+a}},g.prototype.checkSizeRangesSuffixes=function(){if("object"!==e.type(this.settings.sizeRangeSuffixes)){throw"sizeRangeSuffixes must be defined and must be an object"}var i=[];for(var b in this.settings.sizeRangeSuffixes){this.settings.sizeRangeSuffixes.hasOwnProperty(b)&&i.push(b)}for(var d={0:""},a=0;a<i.length;a++){if("string"===e.type(i[a])){try{var c=parseInt(i[a].replace(/^[a-z]+/,""),10);d[c]=this.settings.sizeRangeSuffixes[i[a]]}catch(m){throw"sizeRangeSuffixes keys must contains correct numbers ("+m+")"}}else{d[i[a]]=this.settings.sizeRangeSuffixes[i[a]]}}this.settings.sizeRangeSuffixes=d},g.prototype.retrieveMaxRowHeight=function(){var a={};if("string"===e.type(this.settings.maxRowHeight)){this.settings.maxRowHeight.match(/^[0-9]+%$/)?(a.value=parseFloat(this.settings.maxRowHeight.match(/^([0-9]+)%$/)[1])/100,a.isPercentage=!1):(a.value=parseFloat(this.settings.maxRowHeight),a.isPercentage=!0)}else{if("number"!==e.type(this.settings.maxRowHeight)){throw"maxRowHeight must be a number or a percentage"}a.value=this.settings.maxRowHeight,a.isPercentage=!1}if(isNaN(a.value)){throw"invalid number for maxRowHeight"}return a.isPercentage?a.value<100&&(a.value=100):a.value>0&&a.value<this.settings.rowHeight&&(a.value=this.settings.rowHeight),a},g.prototype.checkSettings=function(){if(this.checkSizeRangesSuffixes(),this.checkOrConvertNumber(this.settings,"rowHeight"),this.checkOrConvertNumber(this.settings,"margins"),this.checkOrConvertNumber(this.settings,"border"),"justify"!==this.settings.lastRow&&"nojustify"!==this.settings.lastRow&&"left"!==this.settings.lastRow&&"center"!==this.settings.lastRow&&"right"!==this.settings.lastRow&&"hide"!==this.settings.lastRow){throw'lastRow must be "justify", "nojustify", "left", "center", "right" or "hide"'}if(this.checkOrConvertNumber(this.settings,"justifyThreshold"),this.settings.justifyThreshold<0||this.settings.justifyThreshold>1){throw"justifyThreshold must be in the interval [0,1]"}if("boolean"!==e.type(this.settings.cssAnimation)){throw"cssAnimation must be a boolean"}if("boolean"!==e.type(this.settings.captions)){throw"captions must be a boolean"}if(this.checkOrConvertNumber(this.settings.captionSettings,"animationDuration"),this.checkOrConvertNumber(this.settings.captionSettings,"visibleOpacity"),this.settings.captionSettings.visibleOpacity<0||this.settings.captionSettings.visibleOpacity>1){throw"captionSettings.visibleOpacity must be in the interval [0, 1]"}if(this.checkOrConvertNumber(this.settings.captionSettings,"nonVisibleOpacity"),this.settings.captionSettings.nonVisibleOpacity<0||this.settings.captionSettings.nonVisibleOpacity>1){throw"captionSettings.nonVisibleOpacity must be in the interval [0, 1]"}if("boolean"!==e.type(this.settings.fixedHeight)){throw"fixedHeight must be a boolean"}if(this.checkOrConvertNumber(this.settings,"imagesAnimationDuration"),this.checkOrConvertNumber(this.settings,"refreshTime"),this.checkOrConvertNumber(this.settings,"refreshSensitivity"),"boolean"!==e.type(this.settings.randomize)){throw"randomize must be a boolean"}if("string"!==e.type(this.settings.selector)){throw"selector must be a string"}if(this.settings.sort!==!1&&!e.isFunction(this.settings.sort)){throw"sort must be false or a comparison function"}if(this.settings.filter!==!1&&!e.isFunction(this.settings.filter)&&"string"!==e.type(this.settings.filter)){throw"filter must be false, a string or a filter function"}},g.prototype.retrieveSuffixRanges=function(){var a=[];for(var b in this.settings.sizeRangeSuffixes){this.settings.sizeRangeSuffixes.hasOwnProperty(b)&&a.push(parseInt(b,10))}return a.sort(function(c,d){return c>d?1:d>c?-1:0}),a},g.prototype.updateSettings=function(a){this.settings=e.extend({},this.settings,a),this.checkSettings(),this.border=this.settings.border>=0?this.settings.border:this.settings.margins,this.maxRowHeight=this.retrieveMaxRowHeight(),this.suffixRanges=this.retrieveSuffixRanges()},e.fn.justifiedGallery=function(a){return this.each(function(d,b){var c=e(b);c.addClass("justified-gallery");var j=c.data("jg.controller");if("undefined"==typeof j){if("undefined"!=typeof a&&null!==a&&"object"!==e.type(a)){if("destroy"===a){return}throw"The argument must be an object"}j=new g(c,e.extend({},e.fn.justifiedGallery.defaults,a)),c.data("jg.controller",j)}else{if("norewind"===a){}else{if("destroy"===a){return void j.destroy()}j.updateSettings(a),j.rewind()}}j.updateEntries("norewind"===a)&&j.init()})},e.fn.justifiedGallery.defaults={sizeRangeSuffixes:{},thumbnailPath:void 0,rowHeight:120,maxRowHeight:-1,margins:1,border:-1,lastRow:"nojustify",justifyThreshold:0.75,fixedHeight:!1,waitThumbnailsLoad:!0,captions:!0,cssAnimation:!1,imagesAnimationDuration:500,captionSettings:{animationDuration:500,visibleOpacity:0.7,nonVisibleOpacity:0},rel:null,target:null,extension:/\.[^.\\/]+$/,refreshTime:200,refreshSensitivity:0,randomize:!1,sort:!1,filter:!1,selector:"> a, > div:not(.spinner)"}}(jQuery);