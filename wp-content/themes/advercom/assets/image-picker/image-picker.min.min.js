(function(){var d,a,b,e,f=function(g,h){return function(){return g.apply(h,arguments)}},c=[].indexOf||function(j){for(var h=0,g=this.length;h<g;h++){if(h in this&&this[h]===j){return h}}return -1};jQuery.fn.extend({imagepicker:function(g){if(g==null){g={}}return this.each(function(){var h;h=jQuery(this);if(h.data("picker")){h.data("picker").destroy()}h.data("picker",new d(this,e(g)));if(g.initialized!=null){return g.initialized.call(h.data("picker"))}})}});e=function(g){var h;h={hide_select:true,show_label:false,initialized:void 0,changed:void 0,clicked:void 0,selected:void 0,limit:void 0,limit_reached:void 0};return jQuery.extend(h,g)};b=function(l,k){var n,m,h,g;if((!l||!k)||(l.length!==k.length)){return false}l=l.slice(0);k=k.slice(0);l.sort();k.sort();for(n=m=0,h=l.length;m<h;n=++m){g=l[n];if(k[n]!==g){return false}}return true};d=(function(){function g(h,i){this.opts=i!=null?i:{};this.sync_picker_with_select=f(this.sync_picker_with_select,this);this.select=jQuery(h);this.multiple=this.select.attr("multiple")==="multiple";if(this.select.data("limit")!=null){this.opts.limit=parseInt(this.select.data("limit"))}this.build_and_append_picker()}g.prototype.destroy=function(){var i,h,k,l;l=this.picker_options;for(i=0,h=l.length;i<h;i++){k=l[i];k.destroy()}this.picker.remove();this.select.off("change",this.sync_picker_with_select);this.select.removeData("picker");return this.select.show()};g.prototype.build_and_append_picker=function(){if(this.opts.hide_select){this.select.hide()}this.select.on("change",this.sync_picker_with_select);if(this.picker!=null){this.picker.remove()}this.create_picker();this.select.after(this.picker);return this.sync_picker_with_select()};g.prototype.sync_picker_with_select=function(){var i,h,l,m,k;m=this.picker_options;k=[];for(i=0,h=m.length;i<h;i++){l=m[i];if(l.is_selected()){k.push(l.mark_as_selected())}else{k.push(l.unmark_as_selected())}}return k};g.prototype.create_picker=function(){this.picker=jQuery("<ul class='thumbnails image_picker_selector'></ul>");this.picker_options=[];this.recursively_parse_option_groups(this.select,this.picker);return this.picker};g.prototype.recursively_parse_option_groups=function(u,q){var h,m,l,r,n,p,t,i,s,o;i=u.children("optgroup");for(m=0,r=i.length;m<r;m++){t=i[m];t=jQuery(t);h=jQuery("<ul></ul>");h.append(jQuery("<li class='group_title'>"+(t.attr("label"))+"</li>"));q.append(jQuery("<li class='group'>").append(h));this.recursively_parse_option_groups(t,h)}s=(function(){var j,w,k,v;k=u.children("option");v=[];for(j=0,w=k.length;j<w;j++){p=k[j];v.push(new a(p,this,this.opts))}return v}).call(this);o=[];for(l=0,n=s.length;l<n;l++){p=s[l];this.picker_options.push(p);if(!p.has_image()){continue}o.push(q.append(p.node))}return o};g.prototype.has_implicit_blanks=function(){var h;return((function(){var k,i,m,l;m=this.picker_options;l=[];for(k=0,i=m.length;k<i;k++){h=m[k];if(h.is_blank()&&!h.has_image()){l.push(h)}}return l}).call(this)).length>0};g.prototype.selected_values=function(){if(this.multiple){return this.select.val()||[]}else{return[this.select.val()]}};g.prototype.toggle=function(j,l){var i,k,h;k=this.selected_values();h=j.value().toString();if(this.multiple){if(c.call(this.selected_values(),h)>=0){i=this.selected_values();i.splice(jQuery.inArray(h,k),1);this.select.val([]);this.select.val(i)}else{if((this.opts.limit!=null)&&this.selected_values().length>=this.opts.limit){if(this.opts.limit_reached!=null){this.opts.limit_reached.call(this.select)}}else{this.select.val(this.selected_values().concat(h))}}}else{if(this.has_implicit_blanks()&&j.is_selected()){this.select.val("")}else{this.select.val(h)}}if(!b(k,this.selected_values())){this.select.change();if(this.opts.changed!=null){return this.opts.changed.call(this.select,k,this.selected_values(),l)}}};return g})();a=(function(){function g(j,i,h){this.picker=i;this.opts=h!=null?h:{};this.clicked=f(this.clicked,this);this.option=jQuery(j);this.create_node()}g.prototype.destroy=function(){return this.node.find(".thumbnail").off("click",this.clicked)};g.prototype.has_image=function(){return this.option.data("img-src")!=null};g.prototype.is_blank=function(){return !((this.value()!=null)&&this.value()!=="")};g.prototype.is_selected=function(){var h;h=this.picker.select.val();if(this.picker.multiple){return jQuery.inArray(this.value(),h)>=0}else{return this.value()===h}};g.prototype.mark_as_selected=function(){return this.node.find(".thumbnail").addClass("selected")};g.prototype.unmark_as_selected=function(){return this.node.find(".thumbnail").removeClass("selected")};g.prototype.value=function(){return this.option.val()};g.prototype.label=function(){if(this.option.data("img-label")){return this.option.data("img-label")}else{return this.option.text()}};g.prototype.clicked=function(h){this.picker.toggle(this,h);if(this.opts.clicked!=null){this.opts.clicked.call(this.picker.select,this,h)}if((this.opts.selected!=null)&&this.is_selected()){return this.opts.selected.call(this.picker.select,this,h)}};g.prototype.create_node=function(){var j,i,h,k;this.node=jQuery("<li/>");j=jQuery("<img class='image_picker_image'/>");j.attr("src",this.option.data("img-src"));k=jQuery("<div class='thumbnail'>");h=this.option.data("img-class");if(h){this.node.addClass(h);j.addClass(h);k.addClass(h)}i=this.option.data("img-alt");if(i){j.attr("alt",i)}k.on("click",this.clicked);k.append(j);if(this.opts.show_label){k.append(jQuery("<p/>").html(this.label()))}this.node.append(k);return this.node};return g})()}).call(this);