(function(){var k,h,g,j,i=function(b,a){return function(){return b.apply(a,arguments)}},l=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++){if(b in this&&this[b]===a){return b}}return -1};jQuery.fn.extend({imagepicker:function(a){if(a==null){a={}}return this.each(function(){var b;b=jQuery(this);if(b.data("picker")){b.data("picker").destroy()}b.data("picker",new k(this,j(a)));if(a.initialized!=null){return a.initialized.call(b.data("picker"))}})}});j=function(b){var a;a={hide_select:true,show_label:false,initialized:void 0,changed:void 0,clicked:void 0,selected:void 0,limit:void 0,limit_reached:void 0};return jQuery.extend(a,b)};g=function(b,c){var f,a,d,e;if((!b||!c)||(b.length!==c.length)){return false}b=b.slice(0);c=c.slice(0);b.sort();c.sort();for(f=a=0,d=b.length;a<d;f=++a){e=b[f];if(c[f]!==e){return false}}return true};k=(function(){function a(c,b){this.opts=b!=null?b:{};this.sync_picker_with_select=i(this.sync_picker_with_select,this);this.select=jQuery(c);this.multiple=this.select.attr("multiple")==="multiple";if(this.select.data("limit")!=null){this.opts.limit=parseInt(this.select.data("limit"))}this.build_and_append_picker()}a.prototype.destroy=function(){var d,e,c,b;b=this.picker_options;for(d=0,e=b.length;d<e;d++){c=b[d];c.destroy()}this.picker.remove();this.select.off("change",this.sync_picker_with_select);this.select.removeData("picker");return this.select.show()};a.prototype.build_and_append_picker=function(){if(this.opts.hide_select){this.select.hide()}this.select.on("change",this.sync_picker_with_select);if(this.picker!=null){this.picker.remove()}this.create_picker();this.select.after(this.picker);return this.sync_picker_with_select()};a.prototype.sync_picker_with_select=function(){var e,f,c,b,d;b=this.picker_options;d=[];for(e=0,f=b.length;e<f;e++){c=b[e];if(c.is_selected()){d.push(c.mark_as_selected())}else{d.push(c.unmark_as_selected())}}return d};a.prototype.create_picker=function(){this.picker=jQuery("<ul class='thumbnails image_picker_selector'></ul>");this.picker_options=[];this.recursively_parse_option_groups(this.select,this.picker);return this.picker};a.prototype.recursively_parse_option_groups=function(z,c){var y,v,w,b,f,d,A,x,B,e;x=z.children("optgroup");for(v=0,b=x.length;v<b;v++){A=x[v];A=jQuery(A);y=jQuery("<ul></ul>");y.append(jQuery("<li class='group_title'>"+(A.attr("label"))+"</li>"));c.append(jQuery("<li class='group'>").append(y));this.recursively_parse_option_groups(A,y)}B=(function(){var p,m,o,n;o=z.children("option");n=[];for(p=0,m=o.length;p<m;p++){d=o[p];n.push(new h(d,this,this.opts))}return n}).call(this);e=[];for(w=0,f=B.length;w<f;w++){d=B[w];this.picker_options.push(d);if(!d.has_image()){continue}e.push(c.append(d.node))}return e};a.prototype.has_implicit_blanks=function(){var b;return((function(){var e,f,c,d;c=this.picker_options;d=[];for(e=0,f=c.length;e<f;e++){b=c[e];if(b.is_blank()&&!b.has_image()){d.push(b)}}return d}).call(this)).length>0};a.prototype.selected_values=function(){if(this.multiple){return this.select.val()||[]}else{return[this.select.val()]}};a.prototype.toggle=function(d,b){var e,c,f;c=this.selected_values();f=d.value().toString();if(this.multiple){if(l.call(this.selected_values(),f)>=0){e=this.selected_values();e.splice(jQuery.inArray(f,c),1);this.select.val([]);this.select.val(e)}else{if((this.opts.limit!=null)&&this.selected_values().length>=this.opts.limit){if(this.opts.limit_reached!=null){this.opts.limit_reached.call(this.select)}}else{this.select.val(this.selected_values().concat(f))}}}else{if(this.has_implicit_blanks()&&d.is_selected()){this.select.val("")}else{this.select.val(f)}}if(!g(c,this.selected_values())){this.select.change();if(this.opts.changed!=null){return this.opts.changed.call(this.select,c,this.selected_values(),b)}}};return a})();h=(function(){function a(b,c,d){this.picker=c;this.opts=d!=null?d:{};this.clicked=i(this.clicked,this);this.option=jQuery(b);this.create_node()}a.prototype.destroy=function(){return this.node.find(".thumbnail").off("click",this.clicked)};a.prototype.has_image=function(){return this.option.data("img-src")!=null};a.prototype.is_blank=function(){return !((this.value()!=null)&&this.value()!=="")};a.prototype.is_selected=function(){var b;b=this.picker.select.val();if(this.picker.multiple){return jQuery.inArray(this.value(),b)>=0}else{return this.value()===b}};a.prototype.mark_as_selected=function(){return this.node.find(".thumbnail").addClass("selected")};a.prototype.unmark_as_selected=function(){return this.node.find(".thumbnail").removeClass("selected")};a.prototype.value=function(){return this.option.val()};a.prototype.label=function(){if(this.option.data("img-label")){return this.option.data("img-label")}else{return this.option.text()}};a.prototype.clicked=function(b){this.picker.toggle(this,b);if(this.opts.clicked!=null){this.opts.clicked.call(this.picker.select,this,b)}if((this.opts.selected!=null)&&this.is_selected()){return this.opts.selected.call(this.picker.select,this,b)}};a.prototype.create_node=function(){var c,d,e,b;this.node=jQuery("<li/>");c=jQuery("<img class='image_picker_image'/>");c.attr("src",this.option.data("img-src"));b=jQuery("<div class='thumbnail'>");e=this.option.data("img-class");if(e){this.node.addClass(e);c.addClass(e);b.addClass(e)}d=this.option.data("img-alt");if(d){c.attr("alt",d)}b.on("click",this.clicked);b.append(c);if(this.opts.show_label){b.append(jQuery("<p/>").html(this.label()))}this.node.append(b);return this.node};return a})()}).call(this);